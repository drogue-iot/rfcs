# [Cloud] Mappings for Cloud Events

We are using Cloud Events for pushing events around. This RFC is for defining how we use the different fields.

* Issue: https://github.com/drogue-iot/drogue-cloud/issues/29
* PR: https://github.com/drogue-iot/rfcs/pull/1

Also see:

* https://github.com/cloudevents/spec/blob/v1.0.1/spec.md
* https://github.com/cloudevents/spec/blob/v1.0.1/documented-extensions.md

## Motivation

In the past we didn't really think how we use the different fields of the cloud events structures. Neither did
we document this. With this document we want to clean up this situation.

## Glossary

<dl>

<dt>Channel</dt>
<dd>
The channel is an indicator of the device to which *data stream* the event belongs. Depending on the protocol, this
can be set by the device, or generated by the protocol endpoint.

For example: In Eclipse Hono these would map to `telemetry` and `event`.
</dd>

<dt>UID</dt>
<dd>
The *unique ID* (UID) is an identifier, which is bound to the lifecycle of a resource (e.g. device). When a resource
with is deleted and re-created with the same name, it will still get a different UID.
</dd>

</dl>

## Requirements and non-goals

* Define how we use the required and optional fields.
* Define which extension attribute we want to use.
* Compare with other projects how they do it.
* This RFC is not about the actual payload, only about the metadata.

## device-to-cloud

Events sent from a device to the cloud.

In most cases the protocol endpoints do not receive a "Cloud Event", but some more device specific event, which the
endpoint must translate into a Cloud Event.

### Core attributes

| Field | Required | Description |
| ----- | -------- | --- |
| `id` | âœ“ | By default a random ID (e.g. UUID) generated by the protocol endpoint. |
| `source` | âœ“ | The full [device id](#device-id) |
| `specversion` | âœ“ | Always contains `1.0` |
| `type` | âœ“ | Type information, as provided by the device. Defaults to `io.drogue.event.v1`. |
| `datacontenttype` | âœ“ | The mime type of the payload. As provided by the device. Defaults to `application/octet-stream`. |
| `dataschema` | | The schema of the payload. As provided by the device. |
| `subject` | âœ“ | The "channel" the device published to. |
| `time` | âœ“ | The time the protocol endpoint picked up the message from the device. If the device wants to send along a timestamp with sensor measurements, then that would be part of the payload. |

The summary would be:

  * What happened? â†’ `type`
  * Where did it happen? â†’ `source` (optionally plus the `subject`)
  * When did we get notified? â†’ `time`
  * When did it happen? â†’ Need to inspect the payload!
  * What do we know? â†’ See payload
  * How is the payload encoded â†’ `datacontenttype`
  * What is in the payload â†’ `dataschema`

### Extension attributes

* Support the `paritionkey`: https://github.com/cloudevents/spec/blob/v1.0.1/extensions/partitioning.md
  
  The partition key should be unique *per device*, to ensure that events of a device are kept in order. 

* Allow the use of the tracing attributes: https://github.com/cloudevents/spec/blob/v1.0.1/extensions/distributed-tracing.md

### Custom attributes

The following table is a set of extension attributes custom to Drogue IoT.

| Field | Type | Required | Description |
| ----- | ---- | -------- | --- |
| `instance` | `String` |  âœ“ | Some identifier of the instance. <br/> Each Drogue Cloud instance must provide a unique constant. |
| `application` | `String` | âœ“ | The name of the application the device belongs to. |
| `applicationuid` | `String` | âœ“ | The *UID* of the application. |
| `device` | `String` | âœ“ | The name of the device the event originated from. |
| `deviceuid` | `String` | âœ“ | The *UID* of the device. |
| `sender` | `String` | âœ“ | The name of the device that sent the event. <br><br> This is the name of the peer that authenticated. In the case of a device, sending its own message (non-gateway), this would be the same as value `device`.|

The goal of the custom attributes is to simplify Drogue IoT specific use cases, like filtering by `application` or
`device` and to provide additional information, not polluting the actual payload.

## cloud-to-device

Messages sent by an application to the *command endpoint*, for delivery to a device.

### Core attributes

| Field | Required | Description |
| ----- | -------- | --- |
| `id` | âœ“ ||
| `source` | âœ“ ||
| `specversion` | âœ“ | Always contains `1.0` |
| `type` | âœ“ | |
| `datacontenttype` | | |
| `dataschema` ||| 
| `subject` |||
| `time` |||

### Extension attributes

* Think about using tracing attributes: https://github.com/cloudevents/spec/blob/v1.0.1/extensions/distributed-tracing.md

## Common Fields

### Device ID

The scoped ID of the device in the following format: `<application>/<device>`.

Application and device IDs must be "URL encoded" to carry special characters. For example:

| Application | Device   | Result |
| ----------- | -------- | ------ |
| `app`       | `device` | `app/device` |
| `app`       | `foo/bar` | `app/foo%2Fbar` |
| `app`       | `foo bar` | `foo%20bar` |
| `app`       | `fÃ¶Ã¶bÃ¤r` | `f%C3%B6%C3%B6b%C3%A4r` |
| `Ã¤pp`       | `device` | ðŸ›‘ Not allowed: Application names must be DNS components |

## Examples

### Default HTTP endpoint

### Default MQTT endpoint

### The Thing Network endpoint
